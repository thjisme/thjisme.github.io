<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TESOL Vocab ‚Äî Student Workspace</title>
<style>
  :root{
    --bg:#0b1025;--fg:#e5e7eb;--mut:#94a3b8;--card:#0f172a;--line:#1f2a44;
    --accent:#60a5fa;--ok:#22c55e;--warn:#ef4444;--amber:#f59e0b
  }
  [data-theme="light"] {
    --bg:#f8fafc;--fg:#1e293b;--mut:#64748b;--card:#ffffff;--line:#e2e8f0;
    --accent:#3b82f6;--ok:#059669;--warn:#dc2626;--amber:#d97706
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    transition:background-color .3s ease,color .3s ease
  }
  body:not([data-theme="light"]) {
    background:radial-gradient(1200px 600px at 20% -10%, #14204a 0%, transparent 60%),
    linear-gradient(180deg,#0b1025,#0f172a);
  }
  a{color:#93c5fd} .wrap{min-height:100svh;display:grid;place-items:center;padding:20px}
  .shell{width:min(1100px,100%);display:grid;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.15);transition:all .3s ease}
  body:not([data-theme="light"]) .card{background:rgba(15,23,42,.72);backdrop-filter:blur(10px);box-shadow:0 20px 60px rgba(0,0,0,.45)}
  .row{display:grid;gap:10px}
  .row2{grid-template-columns:1fr 1fr} .row3{grid-template-columns:2fr 1fr 1fr}
  .row4{grid-template-columns:1.2fr .9fr .9fr .9fr}
  .header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  h1{margin:0;font-size:22px} h2{margin:4px 0 10px;font-size:18px}
  label{font-size:12px;color:#cbd5e1} .muted{color:var(--mut);font-size:12px}
  input,select,textarea{
    width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:var(--card);color:var(--fg);transition:all .3s ease
  }
  body:not([data-theme="light"]) input,
  body:not([data-theme="light"]) select,
  body:not([data-theme="light"]) textarea {border:1px solid #2a3553;background:#0b1220}
  textarea{min-height:80px}
  button{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:700}
  .btn{background:var(--card);border:1px solid var(--line);color:var(--fg);transition:all .3s ease}
  body:not([data-theme="light"]) .btn{background:#1f2937;border:1px solid #2a3553;color:#dbeafe}
  .btn.primary{background:var(--ok);color:#052e16;border-color:#0f3a19}
  .btn.warn{background:var(--warn);color:#fff;border-color:#7f1d1d}
  .btn.ghost{background:transparent;border:1px dashed #2a3553}
  .pill{padding:6px 10px;border-radius:999px;background:var(--card);border:1px solid var(--line);color:var(--mut);font-size:12px;transition:all .3s ease}
  body:not([data-theme="light"]) .pill{background:#0b1220;border:1px solid #2a3553;color:#cbd5e1}
  .nav{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:var(--card);color:var(--mut);cursor:pointer;transition:all .3s ease}
  .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  body:not([data-theme="light"]) .tab{border:1px solid #2a3553;background:#0b1220;color:#cbd5e1}
  body:not([data-theme="light"]) .tab.active{background:#1f2a44;color:#e5e7eb;border-color:#3a4a78}
  .grid-head,.grid-row{display:grid;gap:8px;align-items:start}
  .grid-head{font-weight:700;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;transition:all .3s ease}
  .grid-row{border:1px solid var(--line);border-radius:12px;padding:10px;background:var(--card);transition:all .3s ease}
  body:not([data-theme="light"]) .grid-head{background:#0b1220;border:1px solid #2a3553}
  body:not([data-theme="light"]) .grid-row{border:1px solid #1b2542;background:#0b1220}
  .right{justify-self:end} .hide{display:none}
  .tiny{font-size:11px}
  .stat{display:grid;gap:6px;padding:12px;border:1px solid var(--line);background:var(--card);border-radius:12px;transition:all .3s ease}
  .progress{height:10px;background:var(--card);border:1px solid var(--line);border-radius:999px;overflow:hidden;transition:all .3s ease}
  body:not([data-theme="light"]) .stat{border:1px solid #223055;background:#0b1220}
  body:not([data-theme="light"]) .progress{background:#0b1220;border:1px solid #2a3553}
  .bar{height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);transition:width .3s ease}
  .label-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
  .dot-green{background:#22c55e}.dot-amber{background:#f59e0b}.dot-red{background:#ef4444}
  .list{display:grid;gap:8px}
  .hr{height:1px;background:#1f2a44;margin:10px 0;border-radius:1px}
  .flashcard{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:20px;text-align:center;min-height:200px;display:flex;flex-direction:column;justify-content:center;cursor:pointer;transition:all .3s ease}
  .flashcard:hover{border-color:var(--accent)}
  .flashcard.flipped{background:var(--accent);color:white}
  body:not([data-theme="light"]) .flashcard{background:#0b1220;border:1px solid #2a3553}
  body:not([data-theme="light"]) .flashcard:hover{border-color:#3a4a78}
  body:not([data-theme="light"]) .flashcard.flipped{background:#1f2a44}
  .word{font-size:24px;font-weight:700;margin-bottom:8px}
  .definition{font-size:16px;color:var(--mut)}
  .quiz-option{background:#0b1220;border:1px solid #2a3553;border-radius:12px;padding:12px;cursor:pointer;transition:all .3s ease}
  .quiz-option:hover{border-color:#3a4a78}
  .quiz-option.correct{background:#22c55e;color:#052e16;border-color:#0f3a19}
  .quiz-option.incorrect{background:#ef4444;color:#fff;border-color:#7f1d1d}
</style>
</head>
<body>
<div class="wrap"><div class="shell">

  <!-- Auth Card -->
  <div id="authCard" class="card">
    <div class="header">
      <h1>TESOL Vocabulary ‚Äî Student Workspace</h1>
      <span class="pill">No server ‚Ä¢ Local device storage</span>
    </div>
    <div class="row row2" style="margin-top:8px">
      <form id="loginForm" class="row">
        <h2>Login</h2>
        <label>Username<input id="loginUser" required placeholder="e.g., alice01"></label>
        <label>Passphrase<input id="loginPass" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></label>
        <label style="display:flex;gap:8px;align-items:center">
          <input id="remember" type="checkbox" style="width:auto"> Remember this device for 7 days
        </label>
        <div class="row row2">
          <button class="btn primary" type="submit">Unlock</button>
          <button class="btn" type="button" onclick="showDemo()">Demo Mode</button>
        </div>
        <div class="hr"></div>
        <button class="btn ghost" type="button" onclick="showRegister()">New User? Register Here</button>
      </form>
      
      <form id="registerForm" class="row hide">
        <h2>Register New Account</h2>
        <label>Choose Username<input id="regUser" required placeholder="e.g., alice01"></label>
        <label>Create Passphrase<input id="regPass" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></label>
        <label>Confirm Passphrase<input id="regPassConfirm" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></label>
        <label>Full Name (Optional)<input id="regName" placeholder="e.g., Alice Johnson"></label>
        <div class="row row2">
          <button class="btn primary" type="submit">Create Account</button>
          <button class="btn" type="button" onclick="showLogin()">Back to Login</button>
        </div>
      </form>
      <div class="row">
        <h2>Quick Start</h2>
        <p class="muted">This workspace helps TESOL students practice vocabulary with flashcards, quizzes, and progress tracking. All data stays on your device.</p>
        <div class="muted tiny">
          <div>‚Ä¢ Create and study vocabulary sets</div>
          <div>‚Ä¢ Track learning progress</div>
          <div>‚Ä¢ Practice with interactive quizzes</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hide">
    <!-- Header -->
    <div class="card">
      <div class="header">
        <div>
          <h1>Welcome back, <span id="userName">Student</span></h1>
          <div class="muted">Continue your vocabulary journey</div>
        </div>
        <button class="btn warn" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Navigation -->
    <div class="card">
      <div class="nav">
        <div class="tab active" onclick="showTab('dashboard', this)">Dashboard</div>
        <div class="tab" onclick="showTab('study', this)">Study</div>
        <div class="tab" onclick="showTab('quiz', this)">Quiz</div>
        <div class="tab" onclick="showTab('vocabulary', this)">Vocabulary</div>
        <div class="tab" onclick="showTab('settings', this)">Settings</div>
      </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboardTab" class="card">
      <h2>Your Progress</h2>
      <div class="row row3">
        <div class="stat">
          <div class="muted tiny">WORDS LEARNED</div>
          <div style="font-size:24px;font-weight:700" id="wordsLearned">0</div>
          <div class="progress"><div class="bar" id="progressBar" style="width:0%"></div></div>
        </div>
        <div class="stat">
          <div class="muted tiny">STUDY STREAK</div>
          <div style="font-size:24px;font-weight:700" id="studyStreak">0 days</div>
        </div>
        <div class="stat">
          <div class="muted tiny">QUIZ ACCURACY</div>
          <div style="font-size:24px;font-weight:700" id="quizAccuracy">0%</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="row row2">
        <div>
          <h2>Recent Activity</h2>
          <div id="recentActivity" class="list">
            <div class="muted">No recent activity. Start studying to see your progress!</div>
          </div>
        </div>
        <div>
          <h2>New Word for Today</h2>
          <div id="dailyWordSuggestion" class="card" style="padding:16px;margin:0;background:var(--accent);color:white">
            <div style="font-size:18px;font-weight:700;margin-bottom:8px" id="suggestedWord">Loading...</div>
            <div style="margin-bottom:8px;color:rgba(255,255,255,0.8)" id="suggestedDefinition"></div>
            <button class="btn primary" onclick="addSuggestedWord()" style="width:100%">+ Add to My Vocabulary</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Study Tab -->
    <div id="studyTab" class="card hide">
      <div class="header">
        <h2>Flashcard Study</h2>
        <div class="muted" id="studyProgress">0 / 0 cards</div>
      </div>
      <div id="flashcardContainer">
        <div class="flashcard" id="flashcard" onclick="flipCard()">
          <div class="word" id="cardWord">Click to start studying</div>
          <div class="definition hide" id="cardDefinition"></div>
        </div>
        <div style="text-align:center;margin-top:12px">
          <button class="btn ghost" onclick="playCurrentCardPronunciation()" id="pronounceBtn">üîä Pronounce Word</button>
        </div>
      </div>
      <div class="row row3" style="margin-top:16px">
        <button class="btn" onclick="previousCard()">‚Üê Previous</button>
        <button class="btn primary" onclick="nextCard()">Next ‚Üí</button>
        <button class="btn ghost" onclick="shuffleCards()">üîÄ Shuffle</button>
      </div>
    </div>

    <!-- Quiz Tab -->
    <div id="quizTab" class="card hide">
      <div class="header">
        <h2>Smart Vocabulary Quiz</h2>
        <div class="muted" id="quizProgress">Ready to test your knowledge</div>
      </div>
      <div id="quizContainer">
        <div id="quizQuestion" style="font-size:20px;margin-bottom:20px;text-align:center">
          Click "Random Quiz" to get a weighted random word based on your learning progress
        </div>
        <div id="quizAnswers" class="row hide" style="gap:16px">
          <label>Part of Speech<input id="quizPartOfSpeech" placeholder="e.g., noun, verb, adjective"></label>
          <label>Vietnamese Meaning<input id="quizVietnamese" placeholder="Nghƒ©a ti·∫øng Vi·ªát"></label>
          <label>Example Sentence<textarea id="quizExample" placeholder="Write an example sentence" style="min-height:60px"></textarea></label>
        </div>
        <div id="quizResult" class="hide" style="margin-top:16px;padding:16px;border-radius:12px"></div>
        <div class="row row3" style="margin-top:16px">
          <button class="btn primary" onclick="startRandomQuiz()" id="startQuizBtn">üé≤ Random Quiz</button>
          <button class="btn" onclick="submitQuizAnswer()" id="submitBtn" class="hide">Submit Answer</button>
          <button class="btn ghost" onclick="resetQuiz()">Reset</button>
        </div>
      </div>
    </div>

    <!-- Vocabulary Tab -->
    <div id="vocabularyTab" class="card hide">
      <div class="header">
        <h2>Vocabulary Management</h2>
        <button class="btn primary" onclick="showAddWord()">+ Add Word</button>
      </div>
      <div id="addWordForm" class="row hide" style="margin-bottom:16px">
        <div class="row row2">
          <label>Word<input id="newWord" placeholder="Enter new word"></label>
          <label>Definition<textarea id="newDefinition" placeholder="Enter definition" style="min-height:60px"></textarea></label>
        </div>
        <div class="row row3" style="grid-template-columns: 1fr 1fr 1fr">
          <label>Part of Speech<select id="newPartOfSpeech">
            <option value="">Select part of speech</option>
            <option value="noun">noun</option>
            <option value="verb">verb</option>
            <option value="adjective">adjective</option>
            <option value="adverb">adverb</option>
            <option value="pronoun">pronoun</option>
            <option value="preposition">preposition</option>
            <option value="conjunction">conjunction</option>
            <option value="interjection">interjection</option>
            <option value="determiner">determiner</option>
            <option value="modal">modal</option>
          </select></label>
          <label>Vietnamese Meaning<input id="newVietnamese" placeholder="Nghƒ©a ti·∫øng Vi·ªát"></label>
          <label>Family Words<input id="newFamilyWords" placeholder="Related words (comma separated)"></label>
        </div>
        <div class="row row2">
          <label>Example Sentence 1<textarea id="newExample1" placeholder="First example sentence using this word" style="min-height:60px"></textarea></label>
          <label>Example Sentence 2<textarea id="newExample2" placeholder="Second example sentence using this word" style="min-height:60px"></textarea></label>
        </div>
        <div class="row">
          <label>Personal Notes (Optional)<textarea id="newNotes" placeholder="Add your personal notes, mnemonics, or study tips..." style="min-height:60px"></textarea></label>
        </div>
        <div class="row row4" style="grid-template-columns: 1fr 1fr 1fr 1fr">
          <button class="btn primary" onclick="addWord()">Add Word</button>
          <button class="btn" onclick="enrichWord()">üîç Auto Enrich</button>
          <button class="btn ghost" onclick="playWordPronunciation()">üîä Pronounce</button>
          <button class="btn" onclick="hideAddWord()">Cancel</button>
        </div>
      </div>
      <div class="grid-head" style="grid-template-columns: 1fr; text-align: center;">
        <div>Vocabulary Collection</div>
      </div>
      <div id="vocabularyList" class="list"></div>
    </div>

    <!-- Settings Tab -->
    <div id="settingsTab" class="card hide">
      <h2>Settings</h2>
      <div class="row">
        <h3>Appearance</h3>
        <div class="row row2">
          <label>Theme
            <select id="themeSelect" onchange="changeTheme()">
              <option value="dark">Dark Mode</option>
              <option value="light">Light Mode</option>
            </select>
          </label>
          <div></div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <h3>Notifications</h3>
        <div class="row">
          <label style="display:flex;gap:8px;align-items:center">
            <input id="emailNotifications" type="checkbox" style="width:auto"> Enable email reminders for new vocabulary
          </label>
          <label>Email Address<input id="notificationEmail" placeholder="your.email@example.com" type="email"></label>
          <div class="muted tiny">Note: Email notifications are simulated in this demo. In a real app, this would connect to an email service.</div>
        </div>
      </div>
      <div class="row">
        <button class="btn primary" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>

</div></div>

<script>
// --- POS canonicalization & scoring ---
const ALLOWED_POS = [
  "noun","verb","adjective","adverb","pronoun","preposition",
  "conjunction","interjection","determiner","modal","auxiliary verb","phrasal verb","proper noun","numeral"
];
const RARE_POS_HINTS = /\b(archaic|obsolete|dated|rare|dialectal|nonstandard|vulgar|slang)\b/i;

function normalizePOS(tag){
  const t = String(tag||"").toLowerCase().trim().replace(/\./g,"");
  const map = { n:"noun", v:"verb", adj:"adjective", adv:"adverb",
    pron:"pronoun", prep:"preposition", conj:"conjunction",
    interj:"interjection", det:"determiner", "modal verb":"modal"
  };
  return map[t] || t;
}

function sanitizePOS(list){
  const out = [], seen = new Set();
  (list||[]).forEach(p=>{
    const t = normalizePOS(p);
    if (ALLOWED_POS.includes(t) && !seen.has(t)) { seen.add(t); out.push(t); }
  });
  return out;
}


/* ===== State ===== */
let users = JSON.parse(localStorage.getItem('tesolUsers') || '{}');
let vocabulary = [];
let currentUser = '';
let currentCardIndex = 0;
let isCardFlipped = false;

/* ===== Translation (free) ===== */
const viCache = new Map();
async function translateENtoVI(text) {
  const t = (text || "").trim();
  if (!t) return "";
  if (viCache.has(t)) return viCache.get(t);
  const url = "https://api.mymemory.translated.net/get?q="+encodeURIComponent(t)+"&langpair=en|vi";
  try {
    const r = await fetch(url);
    if (!r.ok) throw new Error("HTTP " + r.status);
    const j = await r.json();
    const vi = (j && j.responseData && j.responseData.translatedText) ? j.responseData.translatedText : "";
    viCache.set(t, vi || "");
    return vi || "";
  } catch { return ""; }
}

/* ===== Sample data ===== */
const sampleVocabulary = [
  { id: 1, word: "Pedagogy", definition: "The method and practice of teaching", partOfSpeech: "noun", posList: ["noun"], vietnamese: "Ph∆∞∆°ng ph√°p gi·∫£ng d·∫°y", example1: "Modern pedagogy emphasizes student-centered learning approaches.", example2: "The university offers courses in educational pedagogy.", familyWords: "pedagogical, pedagogist, pedagogic", learned: true, quizStats: { correct: 3, incorrect: 0, consecutiveCorrect: 3 }, notes: "" },
  { id: 2, word: "Curriculum", definition: "The subjects comprising a course of study", partOfSpeech: "noun", posList: ["noun"], vietnamese: "Ch∆∞∆°ng tr√¨nh h·ªçc", example1: "The new curriculum includes more practical activities.", example2: "Schools must follow the national curriculum guidelines.", familyWords: "curricular, curricula, extracurricular", learned: true, quizStats: { correct: 3, incorrect: 0, consecutiveCorrect: 3 }, notes: "" },
  { id: 3, word: "Assessment", definition: "The evaluation of student learning and progress", partOfSpeech: "noun", posList: ["noun"], vietnamese: "ƒê√°nh gi√°", example1: "Continuous assessment helps track student development.", example2: "The final assessment will include both written and oral components.", familyWords: "assess, assessor, assessable", learned: false, quizStats: { correct: 0, incorrect: 0, consecutiveCorrect: 0 }, notes: "" },
  { id: 4, word: "Differentiation", definition: "Tailoring instruction to meet individual student needs", partOfSpeech: "noun", posList: ["noun"], vietnamese: "Ph√¢n h√≥a gi·∫£ng d·∫°y", example1: "Teachers use differentiation to support diverse learners.", example2: "Effective differentiation requires understanding each student's abilities.", familyWords: "differentiate, differential, differentiated", learned: false, quizStats: { correct: 0, incorrect: 0, consecutiveCorrect: 0 }, notes: "" },
  { id: 5, word: "Scaffolding", definition: "Temporary support structures to help students learn", partOfSpeech: "noun", posList: ["noun"], vietnamese: "H·ªó tr·ª£ h·ªçc t·∫≠p", example1: "The teacher provided scaffolding until students could work independently.", example2: "Good scaffolding gradually removes support as competence increases.", familyWords: "scaffold, scaffolded, scaffolds", learned: false, quizStats: { correct: 0, incorrect: 0, consecutiveCorrect: 0 }, notes: "" },
  { id: 6, word: "Authentic", definition: "Real-world, meaningful learning experiences", partOfSpeech: "adjective", posList: ["adjective"], vietnamese: "Th·ª±c t·∫ø, ch√¢n th·ª±c", example1: "Authentic materials make language learning more engaging.", example2: "Students prefer authentic tasks that connect to real life.", familyWords: "authenticity, authenticate, authentically", learned: false, quizStats: { correct: 0, incorrect: 0, consecutiveCorrect: 0 }, notes: "" },
  { id: 7, word: "Comprehensible", definition: "Understandable input for language learners", partOfSpeech: "adjective", posList: ["adjective"], vietnamese: "C√≥ th·ªÉ hi·ªÉu ƒë∆∞·ª£c", example1: "Teachers should provide comprehensible input at the right level.", example2: "The text was made more comprehensible through visual aids.", familyWords: "comprehend, comprehension, comprehensive", learned: false, quizStats: { correct: 0, incorrect: 0, consecutiveCorrect: 0 }, notes: "" },
  { id: 8, word: "Fluency", definition: "The ability to speak or write smoothly and easily", partOfSpeech: "noun", posList: ["noun"], vietnamese: "Tr√¥i ch·∫£y", example1: "Regular practice helps develop speaking fluency.", example2: "Her fluency in three languages impressed the interviewer.", familyWords: "fluent, fluently, fluidity", learned: false, quizStats: { correct: 0, incorrect: 0, consecutiveCorrect: 0 }, notes: "" }
];

/* ===== Daily word suggestions ===== */
const dailyWordSuggestions = [
  { word: "Collaborate", definition: "Work jointly on an activity", partOfSpeech: "verb" },
  { word: "Innovation", definition: "The action of innovating", partOfSpeech: "noun" },
  { word: "Sustainable", definition: "Able to be maintained at a certain rate", partOfSpeech: "adjective" },
  { word: "Resilience", definition: "The ability to recover quickly from difficulties", partOfSpeech: "noun" },
  { word: "Empathy", definition: "The ability to understand others' feelings", partOfSpeech: "noun" },
  { word: "Articulate", definition: "Express ideas clearly and effectively", partOfSpeech: "verb" },
  { word: "Paradigm", definition: "A typical example or pattern", partOfSpeech: "noun" }
];

/* ===== User data ===== */
function saveUserData() {
  if (currentUser) {
    users[currentUser] = { vocabulary, lastLogin: Date.now(), settings: {} };
    localStorage.setItem('tesolUsers', JSON.stringify(users));
  }
}
function loadUserData() {
  if (currentUser && users[currentUser]) {
    vocabulary = users[currentUser].vocabulary || [...sampleVocabulary];
  } else if (currentUser) {
    vocabulary = [...sampleVocabulary];
    saveUserData();
  }
  updateDashboard();
}

/* ===== Auth ===== */
document.getElementById('loginForm').addEventListener('submit', e=>{
  e.preventDefault();
  const username = document.getElementById('loginUser').value;
  const password = document.getElementById('loginPass').value;
  if (username && password) {
    if (users[username]) { login(username); }
    else { alert('User not found. Please register first or use Demo Mode.'); }
  }
});
document.getElementById('registerForm').addEventListener('submit', e=>{
  e.preventDefault();
  const username = document.getElementById('regUser').value;
  const password = document.getElementById('regPass').value;
  const confirmPassword = document.getElementById('regPassConfirm').value;
  const fullName = document.getElementById('regName').value;
  if (password !== confirmPassword) { alert('Passwords do not match!'); return; }
  if (username && password) {
    if (users[username]) { alert('Username already exists!'); return; }
    users[username] = { password, fullName, vocabulary:[...sampleVocabulary], created:Date.now(), lastLogin:Date.now(), settings:{} };
    localStorage.setItem('tesolUsers', JSON.stringify(users));
    alert('Account created! You can now login.');
    showLogin();
  }
});
function showRegister(){ document.getElementById('loginForm').classList.add('hide'); document.getElementById('registerForm').classList.remove('hide'); }
function showLogin(){
  document.getElementById('registerForm').classList.add('hide');
  document.getElementById('loginForm').classList.remove('hide');
  document.getElementById('regUser').value = '';
  document.getElementById('regPass').value = '';
  document.getElementById('regPassConfirm').value = '';
  document.getElementById('regName').value = '';
}
function login(username){
  currentUser = username;
  document.getElementById('userName').textContent = username;
  document.getElementById('authCard').classList.add('hide');
  document.getElementById('mainApp').classList.remove('hide');
  loadUserData();
}
function showDemo(){
  currentUser = 'Demo User';
  vocabulary = [...sampleVocabulary];
  document.getElementById('userName').textContent = 'Demo User';
  document.getElementById('authCard').classList.add('hide');
  document.getElementById('mainApp').classList.remove('hide');
  updateDashboard();
}
function logout(){
  if (currentUser && currentUser !== 'Demo User') saveUserData();
  currentUser = ''; vocabulary = [];
  document.getElementById('authCard').classList.remove('hide');
  document.getElementById('mainApp').classList.add('hide');
}

/* ===== Tabs (no reliance on window.event) ===== */
function showTab(tabName, el){
  document.querySelectorAll('[id$="Tab"]').forEach(tab => tab.classList.add('hide'));
  document.getElementById(tabName + 'Tab').classList.remove('hide');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  if (tabName === 'study') loadStudyCards();
  else if (tabName === 'vocabulary') loadVocabularyList();
}

/* ===== Dashboard ===== */
function updateDashboard(){
  const learnedCount = vocabulary.filter(w => w.learned).length;
  const totalCount = vocabulary.length;
  const progressPercent = totalCount ? (learnedCount/totalCount)*100 : 0;
  let totalQuizzes=0,totalCorrect=0;
  vocabulary.forEach(w=>{ if(w.quizStats){ totalQuizzes+=w.quizStats.correct+w.quizStats.incorrect; totalCorrect+=w.quizStats.correct; }});
  const quizAccuracy = totalQuizzes ? Math.round((totalCorrect/totalQuizzes)*100) : 0;
  document.getElementById('wordsLearned').textContent = learnedCount;
  document.getElementById('progressBar').style.width = progressPercent + '%';
  document.getElementById('studyStreak').textContent = '3 days';
  document.getElementById('quizAccuracy').textContent = quizAccuracy + '%';
  document.getElementById('recentActivity').innerHTML = `
    <div class="grid-row row3">
      <div><span class="label-dot dot-green"></span>Studied "Pedagogy"</div>
      <div class="muted">2 hours ago</div>
      <div class="right muted tiny">+5 XP</div>
    </div>
    <div class="grid-row row3">
      <div><span class="label-dot dot-amber"></span>Quiz completed</div>
      <div class="muted">Yesterday</div>
      <div class="right muted tiny">Accuracy: ${quizAccuracy}%</div>
    </div>`;
}

/* ===== Study cards ===== */
function loadStudyCards(){ currentCardIndex=0; updateStudyProgress(); showCurrentCard(); }
function showCurrentCard(){
  if (!vocabulary.length) return;
  const card = vocabulary[currentCardIndex];
  document.getElementById('cardWord').textContent = card.word;
  let definitionText = card.definition;
  const posText = (card.posList && card.posList.length) ? card.posList.join(', ') : (card.partOfSpeech || '');
  if (posText) definitionText = `(${posText}) ${definitionText}`;
  if (card.vietnamese) definitionText += `\n\nüáªüá≥ ${card.vietnamese}`;
  if (card.example1)  definitionText += `\n\nExample 1: "${card.example1}"`;
  if (card.example2)  definitionText += `\n\nExample 2: "${card.example2}"`;
  if (card.familyWords) definitionText += `\n\nüë• Family: ${card.familyWords}`;
  document.getElementById('cardDefinition').textContent = definitionText;
  isCardFlipped=false;
  document.getElementById('cardWord').classList.remove('hide');
  document.getElementById('cardDefinition').classList.add('hide');
  document.getElementById('flashcard').classList.remove('flipped');
}
function flipCard(){
  if (!vocabulary.length) return;
  isCardFlipped = !isCardFlipped;
  document.getElementById('cardWord').classList.toggle('hide', isCardFlipped);
  document.getElementById('cardDefinition').classList.toggle('hide', !isCardFlipped);
  document.getElementById('flashcard').classList.toggle('flipped', isCardFlipped);
}
function nextCard(){ if(!vocabulary.length) return; currentCardIndex=(currentCardIndex+1)%vocabulary.length; updateStudyProgress(); showCurrentCard(); }
function previousCard(){ if(!vocabulary.length) return; currentCardIndex = currentCardIndex===0? vocabulary.length-1 : currentCardIndex-1; updateStudyProgress(); showCurrentCard(); }
function shuffleCards(){ vocabulary = vocabulary.sort(()=>Math.random()-0.5); currentCardIndex=0; showCurrentCard(); }
function updateStudyProgress(){ document.getElementById('studyProgress').textContent = `${currentCardIndex+1} / ${vocabulary.length} cards`; }

/* ===== Dictionary / enrichment ===== */
async function fetchDict(word){
  const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Dictionary not found");
  const json = await res.json();
  const e = json[0] || {};
  const phon = Array.isArray(e.phonetics) ? e.phonetics : [];
  const ipa = (phon.find(p=>p.text)?.text) || "";
  const uk  = phon.find(p => /-uk\.mp3(\?|$)/i.test(p?.audio||""));
  const audio = (uk?.audio) || (phon.find(p=>p.audio)?.audio) || "";
  const posSet = new Set(), defs=[], exs=[];
  (e.meanings||[]).forEach(m=>{
    const p = (m.partOfSpeech||"").trim(); if (p) posSet.add(p.toLowerCase());
    (m.definitions||[]).forEach(d=>{
      if (d.definition && defs.length<6) defs.push(d.definition);
      if (d.example && exs.length<6) exs.push(d.example);
    });
  });
  const posList = sanitizePOS([...posSet]);
  const posPrimary = posList[0] || "";
  return { word: e.word || word, ipa, audio, pos: posPrimary, posList, defs, exs };
}
async function enrichWord(){
  const word = document.getElementById('newWord').value.trim();
  if (!word){ alert('Please enter a word first!'); return; }
  const enrichBtn = document.querySelector('button[onclick="enrichWord()"]');
  const originalText = enrichBtn.textContent; enrichBtn.textContent='üîÑ Loading...'; enrichBtn.disabled=true;
  try{
    const dictData = await fetchDict(word);
    const vietnamese = dictData.defs.length ? await translateENtoVI(dictData.defs[0]) : await translateENtoVI(word);
    document.getElementById('newDefinition').value = dictData.defs[0] || `Definition for "${word}" (please edit this)`;
    const posSelect = document.getElementById('newPartOfSpeech');
    if (dictData.posList.length) posSelect.value = dictData.posList[0];
    document.getElementById('newVietnamese').value = vietnamese || `Nghƒ©a c·ªßa "${word}" (vui l√≤ng ch·ªânh s·ª≠a)`;
    document.getElementById('newExample1').value = dictData.exs[0] || `Example sentence using "${word}" (please edit this)`;
    document.getElementById('newExample2').value = dictData.exs[1] || `Another example with "${word}" (please edit this)`;
    document.getElementById('newFamilyWords').value = generateFamilyWords(word);
    alert(`Word enriched! Parts of speech: ${dictData.posList.join(', ') || 'n/a'}`);
  } catch(e){
    console.error('Enrichment failed:', e);
    document.getElementById('newDefinition').value = `Definition for "${word}" (please edit this)`;
    document.getElementById('newPartOfSpeech').value = 'noun';
    document.getElementById('newVietnamese').value = `Nghƒ©a c·ªßa "${word}" (vui l√≤ng ch·ªânh s·ª≠a)`;
    document.getElementById('newExample1').value = `Example sentence using "${word}" (please edit this)`;
    document.getElementById('newExample2').value = `Another example with "${word}" (please edit this)`;
    alert('Auto-enrichment failed. Basic template added‚Äîplease edit.');
  } finally { enrichBtn.textContent = originalText; enrichBtn.disabled=false; }
}

/* Better family word generator (avoids "creater/createtion") */
function generateFamilyWords(word){
  const base = word.toLowerCase();
  const out = new Set();
  // inflections
  if (base.endsWith('e')) { const stem = base.slice(0,-1); out.add(base+'s'); out.add(base+'d'); out.add(stem+'ing'); }
  else if (base.endsWith('y')) { const stem = base.slice(0,-1); out.add(base+'s'); out.add(stem+'ies'); out.add(stem+'ied'); out.add(stem+'ying'); }
  else { out.add(base+'s'); out.add(base+'ed'); out.add(base+'ing'); }
  // common derivations
  if (base.endsWith('ate')) { const s = base.slice(0,-3); out.add(s+'ation'); out.add(s+'ive'); out.add(s+'ivity'); out.add(s+'or'); }
  return [...out].slice(0,6).join(', ');
}

/* ===== Vocabulary list ===== */
function showAddWord(){ document.getElementById('addWordForm').classList.remove('hide'); }
function hideAddWord(){
  document.getElementById('addWordForm').classList.add('hide');
  ['newWord','newDefinition','newPartOfSpeech','newVietnamese','newExample1','newExample2','newFamilyWords','newNotes'].forEach(id=>{
    const el=document.getElementById(id); if (el) el.value = id==='newPartOfSpeech' ? '' : '';
  });
}
async function addWord(){
  const word = document.getElementById('newWord').value.trim();
  const definition = document.getElementById('newDefinition').value.trim();
  const partOfSpeech = document.getElementById('newPartOfSpeech').value;
  const vietnamese = document.getElementById('newVietnamese').value.trim();
  const example1 = document.getElementById('newExample1').value.trim();
  const example2 = document.getElementById('newExample2').value.trim();
  const familyWords = document.getElementById('newFamilyWords').value.trim();
  const notes = document.getElementById('newNotes').value.trim();
  if (!(word && definition)){ alert('Please enter both word and definition!'); return; }
  const newId = vocabulary.length ? Math.max(...vocabulary.map(w=>w.id))+1 : 1;
  let posList = [];
  try { const d = await fetchDict(word); posList = d.posList || []; } catch { if (partOfSpeech) posList=[partOfSpeech]; }
  vocabulary.push({
    id:newId, word, definition,
    partOfSpeech: partOfSpeech || (posList[0]||''),
    posList: posList.length ? posList : (partOfSpeech ? [partOfSpeech] : []),
    vietnamese: vietnamese || '', example1: example1 || '', example2: example2 || '',
    familyWords: familyWords || '', notes: notes || '', learned:false,
    quizStats:{ correct:0, incorrect:0, consecutiveCorrect:0 }
  });
  saveUserData(); hideAddWord(); loadVocabularyList(); updateDashboard();
  if (posList.length) alert(`Word added! POS detected: ${posList.join(', ')}`);
}
  function normPos(s){
  const t = String(s||"").toLowerCase().trim();
  if (!t) return "";
  // normalize common variants
  if (/^adj\b|adjective/.test(t)) return "adjective";
  if (/^adv\b|adverb/.test(t))    return "adverb";
  if (/^n\b|noun/.test(t))        return "noun";
  if (/^v\b|verb/.test(t))        return /phrasal/.test(t) ? "phrasal verb" : "verb";
  if (/phrasal\s*verb/.test(t))   return "phrasal verb";
  if (/preposition/.test(t))      return "preposition";
  if (/conjunction/.test(t))      return "conjunction";
  if (/pronoun/.test(t))          return "pronoun";
  if (/determiner|article/.test(t)) return "determiner";
  if (/interjection/.test(t))     return "interjection";
  return t.replace(/\s+/g," ");
}

function deriveAllPos(word){
  // Prefer array; otherwise split "verb, adjective" / "verb/adjective"
  let arr = Array.isArray(word.posList) && word.posList.length
    ? word.posList.slice()
    : (word.partOfSpeech ? String(word.partOfSpeech).split(/\s*,\s*|\s*\/\s*/) : []);
  arr = arr.map(normPos).filter(Boolean);
  // de-dupe
  return Array.from(new Set(arr));
}

function choosePrimaryPos(word){
  const all = deriveAllPos(word);
  const cam = normPos(word.cambridgePos || word.camPos || "");
  const priority = ["verb","noun","adjective","adverb","phrasal verb","preposition","conjunction","pronoun","determiner","interjection"];

  // Cambridge beats everything if present
  let primary = cam && all.includes(cam) ? cam : "";
  if (!primary){
    for (const p of priority){ if (all.includes(p)){ primary = p; break; } }
  }
  if (!primary) primary = all[0] || "";

  // Optional soft rule: if both verb+adjective and Cambridge ‚â† adjective, hide the adj
  const extras = all.filter(p => p !== primary);
  return { primary, extras };
}

function loadVocabularyList(){
  const listHtml = vocabulary.map(word => {
    const { primary, extras } = choosePrimaryPos(word);
    const extraCnt   = extras.length;
    const extraTitle = extraCnt ? ` title="Also: ${extras.join(', ')}"` : "";
    const posPill    = primary
      ? `<span class="pill" style="font-size:10px;padding:2px 6px;"${extraTitle}>${primary}${extraCnt ? " +" + extraCnt : ""}</span>`
      : "";

    return `
      <div class="grid-row" style="grid-template-columns:1fr;gap:12px;padding:16px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="label-dot ${word.learned ? 'dot-green' : 'dot-amber'}"></span>
          <strong style="font-size:16px;">${word.word}</strong>
          ${posPill}
          ${word.quizStats?.correct>0 ? `<span class="pill" style="font-size:10px;padding:2px 6px;background:#22c55e;color:white;">${word.quizStats.correct}‚úì</span>` : ''}
        </div>

        <div class="muted" style="margin-left:16px;">${word.definition || ""}</div>
        ${word.vietnamese ? `<div class="muted tiny" style="margin-left:16px;color:#60a5fa;">üáªüá≥ ${word.vietnamese}</div>` : ''}
        ${word.familyWords ? `<div class="muted tiny" style="margin-left:16px;color:#f59e0b;">üë• Family: ${word.familyWords}</div>` : ''}
        ${word.example1 ? `<div class="muted tiny" style="margin-left:16px;font-style:italic;">"${word.example1}"</div>` : ''}
        ${word.example2 ? `<div class="muted tiny" style="margin-left:16px;font-style:italic;">"${word.example2}"</div>` : ''}

        <div style="display:flex;gap:8px;margin-left:16px;margin-top:8px;flex-wrap:wrap;">
          <button class="btn tiny" onclick="toggleLearned(${word.id})" ${!word.learned && (!word.quizStats || word.quizStats.consecutiveCorrect<3) ? 'disabled title="Need 3 consecutive correct quiz answers to mark as learned"' : ''}>
            ${word.learned ? 'Mark as Learning' : 'Mark as Learned'}
          </button>
          <button class="btn ghost tiny" onclick="playWordPronunciationById(${word.id})">üîä</button>
          <button class="btn warn tiny" data-action="delete" data-id="${word.id}">Delete</button>
        </div>
      </div>`;
  }).join('');
  document.getElementById('vocabularyList').innerHTML = listHtml;
}


function toggleLearned(id){
  const w = vocabulary.find(x=>x.id===id); if (!w) return;
  w.learned = !w.learned; saveUserData(); loadVocabularyList(); updateDashboard();
}
function deleteWord(id){
  if (!confirm('Are you sure you want to delete this word?')) return;
  vocabulary = vocabulary.filter(w=>w.id!==id);
  saveUserData(); loadVocabularyList(); updateDashboard();
  if (!document.getElementById('quizTab').classList.contains('hide')) resetQuiz();
}

/* ===== Pronunciation ===== */
async function getDictionaryAudioUrl(word, prefer="uk"){
  try{
    const r = await fetch("https://api.dictionaryapi.dev/api/v2/entries/en/"+encodeURIComponent(word.trim().toLowerCase()));
    if (!r.ok) return "";
    const json = await r.json();
    const entry = json?.[0]; if (!entry) return "";
    const ph = Array.isArray(entry.phonetics) ? entry.phonetics : [];
    const urls = [];
    ph.forEach(p=>{ if (p?.audio){ const u=String(p.audio).trim(); if (u && !urls.includes(u)) urls.push(u); }});
    if (!urls.length) return "";
    const uk = urls.find(u=>/-uk\.mp3(\?|$)/i.test(u));
    const us = urls.find(u=>/-us\.mp3(\?|$)/i.test(u));
    return prefer==="uk" ? (uk||us||urls[0]) : (us||uk||urls[0]);
  } catch { return ""; }
}
function getVoice(langCode="en-GB"){
  const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
  let v = voices.find(v=>v.lang && v.lang.toLowerCase()===langCode.toLowerCase());
  if (!v) v = voices.find(v=>v.lang && v.lang.toLowerCase().startsWith("en"));
  return v || null;
}
async function speakTTS(text, lang="en-GB", rate=1.0, pitch=1.0){
  if (!("speechSynthesis" in window)) throw new Error("Speech not supported.");
  if (speechSynthesis.getVoices().length===0){ await new Promise(r=>setTimeout(r,150)); }
  const u = new SpeechSynthesisUtterance(text); u.lang=lang; u.rate=rate; u.pitch=pitch;
  const v = getVoice(lang); if (v) u.voice=v;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}
async function playPronunciation(word, preferAccent="uk"){
  const w = String(word||"").trim(); if (!w) return;
  try{
    const url = await getDictionaryAudioUrl(w, preferAccent);
    if (url){ const audio=new Audio(url); await audio.play(); return; }
    await speakTTS(w, preferAccent==="uk" ? "en-GB" : "en-US");
  } catch { try{ await speakTTS(w, preferAccent==="uk" ? "en-GB" : "en-US"); } catch{} }
}
function playCurrentCardPronunciation(){ if(!vocabulary.length) return; const w=vocabulary[currentCardIndex]; if(w) playPronunciation(w.word,"uk"); }
function playWordPronunciation(){ const w=document.getElementById('newWord').value.trim(); if(w) playPronunciation(w,"uk"); else alert('Please enter a word first!'); }
function playWordPronunciationById(id){ const w=vocabulary.find(x=>x.id===id); if(w) playPronunciation(w.word,"uk"); }

/* ===== Daily suggestion ===== */
let currentSuggestedWord = null;
function loadDailyWordSuggestion(){
  const now=new Date(); const gmt7Time=new Date(now.getTime()+7*60*60*1000); const today=gmt7Time.toDateString();
  const savedSuggestion=localStorage.getItem('dailyWordSuggestion'); const savedDate=localStorage.getItem('dailyWordDate');
  if (savedDate===today && savedSuggestion){ currentSuggestedWord=JSON.parse(savedSuggestion); }
  else {
    const available=dailyWordSuggestions.filter(w=>!vocabulary.some(v=>v.word.toLowerCase()===w.word.toLowerCase()));
    currentSuggestedWord = (available.length?available:dailyWordSuggestions)[Math.floor(Math.random()* (available.length?available.length:dailyWordSuggestions.length))];
    localStorage.setItem('dailyWordSuggestion', JSON.stringify(currentSuggestedWord));
    localStorage.setItem('dailyWordDate', today);
  }
  if (currentSuggestedWord){
    document.getElementById('suggestedWord').textContent=currentSuggestedWord.word;
    document.getElementById('suggestedDefinition').textContent=`(${currentSuggestedWord.partOfSpeech}) ${currentSuggestedWord.definition}`;
  }
}
function addSuggestedWord(){
  if (!currentSuggestedWord) return;
  if (vocabulary.some(w=>w.word.toLowerCase()===currentSuggestedWord.word.toLowerCase())){ alert('This word is already in your vocabulary!'); return; }
  const newId = vocabulary.length ? Math.max(...vocabulary.map(w=>w.id))+1 : 1;
  vocabulary.push({ id:newId, word:currentSuggestedWord.word, definition:currentSuggestedWord.definition, partOfSpeech:currentSuggestedWord.partOfSpeech, posList:[currentSuggestedWord.partOfSpeech], vietnamese:'', example1:'', example2:'', learned:false, quizStats:{correct:0,incorrect:0,consecutiveCorrect:0}, notes:'' });
  saveUserData(); updateDashboard(); alert('Word added! Edit it in the Vocabulary tab.'); loadDailyWordSuggestion();
}

/* ===== Quiz: weighted random, fill-in answers ===== */
let currentQuizWord=null;
function getWeightedRandomWord(){
  const weights = vocabulary.map(word=>{
    if (!word.quizStats) word.quizStats={correct:0,incorrect:0,consecutiveCorrect:0};
    if (word.learned && word.quizStats.correct>=3) return .2;
    if (word.quizStats.correct>=3) return .3;
    if (word.quizStats.incorrect>word.quizStats.correct) return .9;
    if (word.quizStats.correct===0 && word.quizStats.incorrect===0) return 1.0;
    return .6;
  });
  const total = weights.reduce((s,w)=>s+w,0); if (!total) return vocabulary[0];
  let r = Math.random()*total;
  for (let i=0;i<vocabulary.length;i++){ r-=weights[i]; if (r<=0) return vocabulary[i]; }
  return vocabulary[0];
}
function startRandomQuiz(){
  if (!vocabulary.length){ alert('Add some words first!'); return; }
  currentQuizWord = getWeightedRandomWord();
  document.getElementById('quizQuestion').innerHTML = `
    <div style="font-size:24px;font-weight:700;margin-bottom:16px">${currentQuizWord.word}</div>
    <div class="muted">Fill in the information about this word:</div>`;
  document.getElementById('quizAnswers').classList.remove('hide');
  document.getElementById('startQuizBtn').classList.add('hide');
  document.getElementById('submitBtn').classList.remove('hide');
  document.getElementById('quizResult').classList.add('hide');
  document.getElementById('quizPartOfSpeech').value='';
  document.getElementById('quizVietnamese').value='';
  document.getElementById('quizExample').value='';
  document.getElementById('quizProgress').textContent=`Testing: ${currentQuizWord.word}`;
}
function submitQuizAnswer(){
  if (!currentQuizWord) return;
  const userPOS = document.getElementById('quizPartOfSpeech').value.trim().toLowerCase();
  const userVietnamese = document.getElementById('quizVietnamese').value.trim();
  const userExample = document.getElementById('quizExample').value.trim();
  if (!currentQuizWord.quizStats) currentQuizWord.quizStats={correct:0,incorrect:0,consecutiveCorrect:0};
  let correctAnswers=0, totalAnswers=3;
  const wordPOSList = (currentQuizWord.posList || [currentQuizWord.partOfSpeech]).filter(Boolean).map(s=>s.toLowerCase());
  const variations = { noun:['n','nouns'], verb:['v','verbs'], adjective:['adj','adjectives'], adverb:['adv','adverbs'], pronoun:['pron','pronouns'], preposition:['prep','prepositions'], conjunction:['conj','conjunctions'], interjection:['interj','interjections'] };
  const partOfSpeechCorrect = wordPOSList.some(pos=>{
    if (userPOS===pos) return true;
    const v = variations[pos] || [];
    return v.includes(userPOS) || (Object.keys(variations).some(k=>variations[k].includes(pos) && (k===userPOS || variations[k].includes(userPOS))));
  });
  const vietnameseCorrect = userVietnamese.length>0 && ((currentQuizWord.vietnamese||'').toLowerCase().includes(userVietnamese.toLowerCase()) || userVietnamese.toLowerCase().includes((currentQuizWord.vietnamese||'').toLowerCase()));
  const exampleCorrect = userExample.length>0 && userExample.toLowerCase().includes(currentQuizWord.word.toLowerCase());
  if (partOfSpeechCorrect) correctAnswers++; if (vietnameseCorrect) correctAnswers++; if (exampleCorrect) correctAnswers++;
  const score = Math.round((correctAnswers/totalAnswers)*100);
  const passed = score>=70;
  if (passed){ currentQuizWord.quizStats.correct++; currentQuizWord.quizStats.consecutiveCorrect++; if (currentQuizWord.quizStats.consecutiveCorrect>=3 && !currentQuizWord.learned){ currentQuizWord.learned=true; alert(`Congratulations! "${currentQuizWord.word}" is marked as learned.`); } }
  else { currentQuizWord.quizStats.incorrect++; currentQuizWord.quizStats.consecutiveCorrect=0; }
  document.getElementById('quizResult').innerHTML = `
    <div style="text-align:center">
      <div style="font-size:36px;margin-bottom:10px">${score}%</div>
      <div style="margin-bottom:16px">${passed?'‚úÖ Passed!':'‚ùå Keep practicing'}</div>
      <div class="row" style="text-align:left;gap:8px">
        <div>Part of Speech: ${partOfSpeechCorrect?'‚úÖ':'‚ùå'} ${(currentQuizWord.posList||[]).join(', ') || currentQuizWord.partOfSpeech}</div>
        <div>Vietnamese: ${vietnameseCorrect?'‚úÖ':'‚ùå'} ${currentQuizWord.vietnamese||''}</div>
        <div>Example: ${exampleCorrect?'‚úÖ':'‚ùå'} "${currentQuizWord.example1 || currentQuizWord.example || ''}"</div>
      </div>
    </div>`;
  document.getElementById('quizResult').classList.remove('hide');
  document.getElementById('submitBtn').classList.add('hide');
  document.getElementById('startQuizBtn').classList.remove('hide');
  saveUserData(); updateDashboard();
}
function resetQuiz(){
  currentQuizWord=null;
  document.getElementById('quizQuestion').textContent = 'Click "Random Quiz" to get a weighted random word based on your learning progress';
  document.getElementById('quizAnswers').classList.add('hide');
  document.getElementById('quizResult').classList.add('hide');
  document.getElementById('startQuizBtn').classList.remove('hide');
  document.getElementById('submitBtn').classList.add('hide');
  document.getElementById('quizProgress').textContent='Ready to test your knowledge';
  document.getElementById('quizPartOfSpeech').value='';
  document.getElementById('quizVietnamese').value='';
  document.getElementById('quizExample').value='';
}

/* ===== Settings ===== */
function changeTheme(){ const theme=document.getElementById('themeSelect').value; document.body.setAttribute('data-theme',theme); localStorage.setItem('theme',theme); }
function saveSettings(){
  const settings={ theme:document.getElementById('themeSelect').value, emailNotifications:document.getElementById('emailNotifications').checked, notificationEmail:document.getElementById('notificationEmail').value };
  localStorage.setItem('userSettings', JSON.stringify(settings));
  changeTheme();
  if (settings.emailNotifications && settings.notificationEmail) alert(`Email notifications enabled for ${settings.notificationEmail}.`);
  alert('Settings saved successfully!');
}
function loadSettings(){
  const settings = JSON.parse(localStorage.getItem('userSettings')||'{}');
  if (settings.theme){ document.getElementById('themeSelect').value=settings.theme; document.body.setAttribute('data-theme',settings.theme); }
  if (settings.emailNotifications!==undefined) document.getElementById('emailNotifications').checked=settings.emailNotifications;
  if (settings.notificationEmail) document.getElementById('notificationEmail').value=settings.notificationEmail;
}

/* ===== Global event delegation for Delete ===== */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-action="delete"]');
  if (btn){
    const id = Number(btn.dataset.id);
    if (!Number.isFinite(id)) return;
    deleteWord(id);
  }
});

/* ===== Init ===== */
window.addEventListener('beforeunload', ()=>{ if (currentUser && currentUser!=='Demo User') saveUserData(); });
document.addEventListener('DOMContentLoaded', ()=>{ loadSettings(); loadDailyWordSuggestion(); });
</script>
</body>
</html>

<script>
// ===== Accurate POS resolver (drop-in) =====

// Map to canonical POS
function normalizePOS(tag){
  const t = String(tag||"").toLowerCase().trim();
  const map = {
    n:"noun", nouns:"noun", noun:"noun", "proper noun":"proper noun",
    v:"verb", verbs:"verb", verb:"verb", "auxiliary verb":"auxiliary verb",
    "phrasal verb":"phrasal verb",
    adj:"adjective", adjectives:"adjective", adjective:"adjective",
    adv:"adverb", adverbs:"adverb", adverb:"adverb",
    pron:"pronoun", pronouns:"pronoun", pronoun:"pronoun",
    prep:"preposition", prepositions:"preposition", preposition:"preposition",
    conj:"conjunction", conjunctions:"conjunction", conjunction:"conjunction",
    interj:"interjection", interjections:"interjection", interjection:"interjection",
    det:"determiner", determiner:"determiner", article:"determiner",
    modal:"modal", "modal verb":"modal"
  };
  return map[t] || t;
}

function sanitizePOS(list){
  const ALLOWED = new Set([
    "noun","verb","adjective","adverb","pronoun","preposition",
    "conjunction","interjection","determiner","modal",
    "auxiliary verb","phrasal verb","proper noun"
  ]);
  const out=[], seen=new Set();
  (list||[]).forEach(p=>{
    const c = normalizePOS(p);
    if (ALLOWED.has(c) && !seen.has(c)){ seen.add(c); out.push(c); }
  });
  return out;
}

// Extra free source: Datamuse POS (good modern coverage)
async function fetchDatamusePOS(word){
  try{
    const r = await fetch(`https://api.datamuse.com/words?sp=${encodeURIComponent(word)}&md=p&max=10`);
    if(!r.ok) return [];
    const arr = await r.json();
    const hit = arr.find(x => (x.word||"").toLowerCase() === word.toLowerCase());
    const tags = (hit && hit.tags) || [];
    const map = { n:"noun", v:"verb", adj:"adjective", adv:"adverb" };
    const dm = tags.map(t => map[t]).filter(Boolean);
    // remove dups
    return [...new Set(dm)];
  }catch{ return []; }
}

  // Score a meaning: reward good examples/defs, penalize "archaic/obsolete/dated"
function scoreMeaning(meaning){
  let s = 0;
  for (const d of (meaning.definitions||[])){
    if (d.definition) s += 1;
    if (d.example)    s += 0.5;
    if (RARE_POS_HINTS.test(d.definition||"") || RARE_POS_HINTS.test(d.example||"")) s -= 1.5;
  }
  return s;
}

// Dictionary lookup with POS ranking & filtering
async function fetchDict(word){
  const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Dictionary not found");
  const json = await res.json();
  const e = json[0] || {};

  // IPA + audio (prefer a UK mp3 if present)
  const phon = Array.isArray(e.phonetics) ? e.phonetics : [];
  const ipa  = (phon.find(p=>p.text)?.text) || "";
  const uk   = phon.find(p => /-uk\.mp3(\?|$)/i.test(p?.audio||""));
  const audio = (uk?.audio) || (phon.find(p=>p.audio)?.audio) || "";

  // Aggregate POS with scores
  const posScores = {};
  const defs = [], exs = [];

  for (const m of (e.meanings||[])){
    const pos = normalizePOS(m.partOfSpeech||"");
    if (!pos) continue;
    const s = scoreMeaning(m);
    posScores[pos] = (posScores[pos] || 0) + s;

    for (const d of (m.definitions||[])){
      if (d.definition && defs.length<6) defs.push(d.definition);
      if (d.example    && exs.length <6) exs.push(d.example);
    }
  }

  // Rank POS by score (highest first) and drop those that look rare/archaic overall
  let posList = Object.keys(posScores)
    .filter(p => ALLOWED_POS.includes(p))
    .sort((a,b)=> posScores[b]-posScores[a]);

  // Hide weak/rare senses (score <= 0) unless they are the ONLY sense
  if (posList.length > 1) posList = posList.filter(p => posScores[p] > 0);

  // Safety fallback
  if (!posList.length && Object.keys(posScores).length){
    posList = [Object.keys(posScores).sort((a,b)=>posScores[b]-posScores[a])[0]];
  }

  posList = sanitizePOS(posList);
  const posPrimary = posList[0] || "";

  return { word: e.word || word, ipa, audio, pos: posPrimary, posList, defs, exs };
}
// ------- OPTIONAL: one-time POS refresher for existing words -------
async function refreshPOSForAllOnce(){
  try{
    if(localStorage.getItem("pos_fix_done_v2")) return;
    for(const w of (vocabulary||[])){
      try{
        const d = await fetchDict(w.word);
        w.posList = d.posList;
        w.partOfSpeech = d.pos || (d.posList[0]||"");
      }catch(_){}
    }
    saveUserData();
    loadVocabularyList();
    localStorage.setItem("pos_fix_done_v2","1");
  }catch(_){}
}

// Run it once after the app loads (safe to keep even if already ran)
document.addEventListener('DOMContentLoaded', ()=> {
  setTimeout(refreshPOSForAllOnce, 300);
});
// ===== End POS resolver =====
</script>
